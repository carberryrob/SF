USE [Enterprise32]
GO
/****** Object:  StoredProcedure [dbo].[sp_Quotation-SF]    Script Date: 8/22/2024 10:40:01 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 ALTER PROCEDURE [dbo].[sp_Quotation-SF]  @CombineQuote SMALLINT,  @ShowSalesTax SMALLINT,  @ShowPriceM SMALLINT,  @ShowPriceEach SMALLINT,  @ShowAddColor SMALLINT,  @ShowAddM SMALLINT,  @JobType VARCHAR(20),  @KeyNumber VARCHAR(20),  @CombineQty SMALLINT  AS  SET NOCOUNT ON  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  Declare @ExchangeRate as real   SET @ExchangeRate = (case when @JobType = 'ORDER' then  IsNull((Select case when OH.ExchangeRate = 0 then 1 else OH.ExchangeRate end From OrderHeader OH WHERE OH.JobNumber = @KeyNumber),1)  else IsNull((Select case when EH.ExchangeRate = 0 then 1 else EH.ExchangeRate end From EstimateHeader EH WHERE EH.EstimateNumber = @KeyNumber),1)  end)
   IF @JobType <> 'ORDER'  SELECT  @ShowSalesTax AS ShowSalesTax,  @ShowPriceM AS ShowPriceM,  @ShowPriceEach AS ShowPriceEach,  @ShowAddColor AS ShowAddColor,  @ShowAddM AS ShowAddM,  @CombineQuote AS CombineQuote,  EstimateComponent.EstimateNumber,  EstimateComponent.ComponentNumber,  EstimateComponent.Description,  EstimateComponent.Sides,  EstimateComponent.InksSide1,  EstimateComponent.InksSide2,  EstimateComponent.Lots,  EstimateComponent.PagesPerLot,  EstimateComponent.TemplateCode,  EstimateComponent.PartsToPrint,  EstimateComponent.RequireBleed,  EstimateComponent.FinGoodCode,  EstimateComponent.FinalSize,  EstimateComponent.FinishSize,  EstimateComponent.PressSize,  EstimateComponent.PressInstructions,  EstimateComponent.PPInstructions,  EstimateComponent.ASInstructions,  EstimateComponent.StockInstructions,  EstimateComponent.PostInstructions,  EstimateComponent.DetailDescription,  EstimateComponent.JobNumber,  EstimateComponent.RFQ,  EstimateComponent.ParentSize,  EstimateComponent.InkInstructions,  EstimateComponent.ComponentType,  EstimateHeader.CustAccount,  EstimateHeader.CustName,  EstimateHeader.CustAddress1,  EstimateHeader.CustAddress2,  EstimateHeader.CustCity,  EstimateHeader.CustState,  EstimateHeader.CustZip,  EstimateHeader.CustPhone,  EstimateHeader.CustFax,  EstimateHeader.CustContact,  EstimateHeader.CustCountry,  EstimateHeader.CustEmail,  EstimateHeader.SalesRepCode,  EstimateHeader.EndUserName,  EstimateHeader.EndUserAccount,  EstimateHeader.CSR,  EstimateHeader.Estimator,  EstimateHeader.JobDescription,  EstimateHeader.EstimateDate,  EstimateHeader.EstTimeFrame,  EstimateHeader.MJobDetailDescription,  EstimateHeader.Notes,  EstimateQtyTable.Quantity,  EstimateQtyTable.TotalPrice * @ExchangeRate as TotalPrice,  EstimateQtyTable.AddColorPrice * @ExchangeRate as AddColorPrice,  EstimateQtyTable.AddColorMatPrice,  (EstimateQtyTable.AddMPrice * ((EstimateHeader.CommissionA / 100) + 1)) * @ExchangeRate  AS AddMPrice,  (EstimateQtyTable.TaxAmountA + EstimateQtyTable.TaxAmountB + EstimateQtyTable.TaxAmountC + EstimateQtyTable.TaxAmountD) * @ExchangeRate AS TaxAmount,  EstimateCombineQuote.Quantity1,  EstimateCombineQuote.Quantity2,  EstimateCombineQuote.Quantity3,  EstimateCombineQuote.Quantity4,  EstimateCombineQuote.Quantity5,  EstimateCombineQuote.Quantity6,  EstimateCombineQuote.TotalPrice1,  EstimateCombineQuote.TotalPrice2,  EstimateCombineQuote.TotalPrice3,  EstimateCombineQuote.TotalPrice4,  EstimateCombineQuote.TotalPrice5,  EstimateCombineQuote.TotalPrice6,  EstimateCombineQuote.AddColorPrice1,  EstimateCombineQuote.AddColorPrice2,  EstimateCombineQuote.AddColorPrice3,  EstimateCombineQuote.AddColorPrice4,  EstimateCombineQuote.AddColorPrice5,  EstimateCombineQuote.AddColorPrice6,  EstimateCombineQuote.AddColorMatPrice1,  EstimateCombineQuote.AddColorMatPrice2,  EstimateCombineQuote.AddColorMatPrice3,  EstimateCombineQuote.AddColorMatPrice4,  EstimateCombineQuote.AddColorMatPrice5,  EstimateCombineQuote.AddColorMatPrice6,  EstimateCombineQuote.AddMPrice1,  EstimateCombineQuote.AddMPrice2,  EstimateCombineQuote.AddMPrice3,  EstimateCombineQuote.AddMPrice4,  EstimateCombineQuote.AddMPrice5,  EstimateCombineQuote.AddMPrice6,  EstimateCombineQuote.TaxAmount1,  EstimateCombineQuote.TaxAmount2,  EstimateCombineQuote.TaxAmount3,  EstimateCombineQuote.TaxAmount4,  EstimateCombineQuote.TaxAmount5,  EstimateCombineQuote.TaxAmount6,  SalesRep.Description AS SalesRepName,  EstimateProcess.BWT,  EstimateProcess.Description AS ProcessDescription,  EstimateProcess.Color,  EstimateProcess.ItemNumber,  EstimateProcess.GroupNo,  EstimateProcess.Caliper,  EstimateProcess.ColorsSide1,  EstimateProcess.ColorsSide2,  Terms.Description AS TermsDescription,  EstimateComponentText.DetailDescription AS MCompDetailDescription,  EstimateComponentText.PPInstructions AS MPPInstructions,  EstimateComponentText.PostInstructions AS MPostInstructions,  Terms.Code AS TermsCode,  EstimateComponentText.StockInstructions AS MStockInstructions,  EstimateComponentText.ASInstructions AS MASInstructions,  Company.CompanyName,  Company.CompanyAddress1,  Company.CompanyAddress2,  Company.CompanyAddress3,  Company.CompanyCity,  Company.CompanyState,  Company.CompanyZip,  Company.CompanyPhone,  Company.CompanyFax,  Company.CompanyCountry,  Company.QuoteMessage,  EstimateHeader.MNotes,  Contact.Phone AS ContactPhone,  Contact.Fax AS ContactFax,  EstimateHeader.PlantID,  Company.MQuoteMessage,  Company.CompanyName AS PlantName,  Company.CompanyAddress1 AS PlantAddress1,  Company.CompanyAddress2 AS PlantAddress2,  Company.CompanyAddress3 AS PlantAddress3,  Company.CompanyCity AS PlantCity,  Company.CompanyState AS PlantState,  Company.CompanyZip AS PlantZip,  Company.CompanyPhone AS PlantPhone,  Company.CompanyFax AS PlantFax,  Company.CompanyCountry AS PlantCountry,  Company.MQuoteMessage AS PlantMQuoteMessage,  (Select OptionValue from AccessControl Where Source = 'SystemSetting' and LoginName = 'PSD' and OptionName = 'CountryVersion') as CountryVersion,  EstimateHeader.CustAddress3,  TempQuoteReport.AddChargeDescription1,  TempQuoteReport.AddChargeDescription2,  TempQuoteReport.AddChargeDescription3,  TempQuoteReport.AddChargeCost1,  TempQuoteReport.AddChargeCost2,  TempQuoteReport.AddChargeCost3,  TempQuoteReport.Prepress1,  TempQuoteReport.Prepress2,  TempQuoteReport.Prepress3,  TempQuoteReport.Prepress4,  TempQuoteReport.Prepress5,  TempQuoteReport.Prepress6,  TempQuoteReport.Prepress7,  TempQuoteReport.Prepress8,  TempQuoteReport.Prepress9,  TempQuoteReport.Prepress10,  TempQuoteReport.Postpress1,  TempQuoteReport.Postpress2,  TempQuoteReport.Postpress3,  TempQuoteReport.Postpress4,  TempQuoteReport.Postpress5,  TempQuoteReport.Postpress6,  TempQuoteReport.Postpress7,  TempQuoteReport.Postpress8,  TempQuoteReport.Postpress9,  TempQuoteReport.Postpress10,  EstimateComponent.FinalWidth,  EstimateComponent.FinalLength,  EstimateCombineQuote.CQuantity1,  EstimateCombineQuote.CQuantity2,  EstimateCombineQuote.CQuantity3,  EstimateCombineQuote.CQuantity4,  EstimateCombineQuote.CQuantity5,  EstimateCombineQuote.CQuantity6,  Contact.CellPhone AS ContactCellPhone,  Contact.Email AS ContactEmail,  Contact.JobTitle,  SalesRep.Title AS SalesRepTitle,  EstimateComponent.UserDefined1 AS CUserDefined1,  EstimateComponent.UserDefined2 AS CUserDefined2,  EstimateComponent.UserDefined3 AS CUserDefined3,  EstimateComponent.UserDefined4 AS CUserDefined4,  EstimateComponent.UserDefined5 AS CUserDefined5,  EstimateComponent.Color1SidedSheets,  EstimateComponent.Color2SidedSheets,  EstimateComponent.BlankSheets,  EstimateComponentText.InkInstructions AS MInkInstructions,  EstimateComponentText.PressInstructions AS MPressInstructions,  EstimateComponent.ComboSheets,  EstimateHeader.UserDefined1 AS HUserDefined1,  EstimateHeader.UserDefined2 AS HUserDefined2,  EstimateHeader.UserDefined3 AS HUserDefined3,  EstimateHeader.UserDefined4 AS HUserDefined4,  EstimateHeader.UserDefined5 AS HUserDefined5,  EstimateQtyTable.QuantityLineNo,  EstimateHeader.TotalComponents,  Company.ReportImage,  EstimateComponent.GroupName,  SalesRep.Phone AS SalesRepPhone,  SalesRep.Email AS SalesRepEmail,  Employee.Phone AS EstPhone, Employee.MobilePhone AS EstMobile, Employee.Email AS EstEmail, EstimateComponent.FlexoDieCharge  FROM   EstimateQtyTable  INNER JOIN EstimateComponent  ON EstimateQtyTable.EstimateNumber = EstimateComponent.EstimateNumber  AND EstimateQtyTable.ComponentNumber = EstimateComponent.ComponentNumber  INNER JOIN EstimateComponentText  ON EstimateComponent.EstimateNumber = EstimateComponentText.EstimateNumber  AND EstimateComponent.ComponentNumber = EstimateComponentText.ComponentNumber  INNER JOIN EstimateHeader  ON EstimateComponent.EstimateNumber = EstimateHeader.EstimateNumber  INNER JOIN EstimateCombineQuote  ON EstimateHeader.EstimateNumber = EstimateCombineQuote.EstimateNumber  LEFT JOIN SalesRep  ON EstimateHeader.SalesRepCode = SalesRep.Code  LEFT OUTER JOIN Employee ON EstimateHeader.Estimator = Employee.Code  LEFT JOIN EstimateProcess  ON EstimateComponent.EstimateNumber = EstimateProcess.EstimateNumber  AND EstimateComponent.ComponentNumber = EstimateProcess.ComponentNumber  AND (EstimateProcess.GroupNo = 3 AND EstimateProcess.ItemNumber = 1)  LEFT JOIN Customer  ON EstimateHeader.CustAccount = Customer.Account  LEFT JOIN Contact  ON Customer.Account = Contact.Account  AND EstimateHeader.CustContactID = Contact.ID  LEFT JOIN Terms  ON Customer.TermsCode = Terms.Code  LEFT JOIN TempQuoteReport  ON EstimateComponent.EstimateNumber = TempQuoteReport.KeyNumber  AND EstimateComponent.ComponentNumber = TempQuoteReport.ComponentNumber  AND TempQuoteReport.JobType = 'ESTIMATE'  LEFT JOIN Company  ON Company.CompanyID = (CASE WHEN EstimateHeader.PlantID <> '' THEN EstimateHeader.PlantID ELSE 'PSD' END)  WHERE   EstimateHeader.EstimateNumber = @KeyNumber  ELSE
 
   SELECT   @ShowSalesTax AS ShowSalesTax,  @ShowPriceM AS ShowPriceM,  @ShowPriceEach AS ShowPriceEach,  @ShowAddColor AS ShowAddColor,  @ShowAddM AS ShowAddM,  @CombineQuote AS CombineQuote,  OrderComponent.EstimateNumber,  OrderComponent.ComponentNumber,  OrderComponent.Description,  OrderComponent.Sides,  OrderComponent.InksSide1,  OrderComponent.InksSide2,  OrderComponent.Lots,  OrderComponent.PagesPerLot,  OrderComponent.TemplateCode,  OrderComponent.PartsToPrint,  OrderComponent.RequireBleed,  OrderComponent.FinGoodCode,  OrderComponent.FinalSize,  OrderComponent.FinishSize,  OrderComponent.PressSize,  OrderComponent.PressInstructions,  OrderComponent.PPInstructions,  OrderComponent.ASInstructions,  OrderComponent.StockInstructions,  OrderComponent.PostInstructions,  OrderComponent.DetailDescription,  OrderComponent.JobNumber,  OrderComponent.RFQ,  OrderComponent.ParentSize,  OrderComponent.InkInstructions,  OrderComponent.ComponentType,  OrderHeader.CustAccount,  OrderHeader.CustName,  OrderHeader.CustAddress1,  OrderHeader.CustAddress2,  OrderHeader.CustCity,  OrderHeader.CustState,  OrderHeader.CustZip,  OrderHeader.CustPhone,  OrderHeader.CustFax,  OrderHeader.CustContact,  OrderHeader.CustCountry,  OrderHeader.CustEmail,  OrderHeader.SalesRepCode,  OrderHeader.EndUserName,  OrderHeader.EndUserAccount,  OrderHeader.CSR,  OrderHeader.Estimator,  OrderHeader.JobDescription,  OrderHeader.EstimateDate,  OrderHeader.EstTimeFrame,  OrderHeader.MJobDetailDescription,  OrderHeader.Notes,  OrderQtyTable.Quantity,  OrderQtyTable.TotalPrice * @ExchangeRate as TotalPrice,  OrderQtyTable.AddColorPrice * @ExchangeRate as AddColorPrice,  OrderQtyTable.AddColorMatPrice,  (OrderQtyTable.AddMPrice * ((OrderHeader.CommissionA / 100) + 1)) * @ExchangeRate AS AddMPrice,  (OrderQtyTable.TaxAmountA + OrderQtyTable.TaxAmountB + OrderQtyTable.TaxAmountC + OrderQtyTable.TaxAmountD) * @ExchangeRate AS TaxAmount,  OrderCombineQuote.Quantity1,  OrderCombineQuote.Quantity2,  OrderCombineQuote.Quantity3,  OrderCombineQuote.Quantity4,  OrderCombineQuote.Quantity5,  OrderCombineQuote.Quantity6,  OrderCombineQuote.TotalPrice1,  OrderCombineQuote.TotalPrice2,  OrderCombineQuote.TotalPrice3,  OrderCombineQuote.TotalPrice4,  OrderCombineQuote.TotalPrice5,  OrderCombineQuote.TotalPrice6,  OrderCombineQuote.AddColorPrice1,  OrderCombineQuote.AddColorPrice2,  OrderCombineQuote.AddColorPrice3,  OrderCombineQuote.AddColorPrice4,  OrderCombineQuote.AddColorPrice5,  OrderCombineQuote.AddColorPrice6,  OrderCombineQuote.AddColorMatPrice1,  OrderCombineQuote.AddColorMatPrice2,  OrderCombineQuote.AddColorMatPrice3,  OrderCombineQuote.AddColorMatPrice4,  OrderCombineQuote.AddColorMatPrice5,  OrderCombineQuote.AddColorMatPrice6,  OrderCombineQuote.AddMPrice1,  OrderCombineQuote.AddMPrice2,  OrderCombineQuote.AddMPrice3,  OrderCombineQuote.AddMPrice4,  OrderCombineQuote.AddMPrice5,  OrderCombineQuote.AddMPrice6,  OrderCombineQuote.TaxAmount1,  OrderCombineQuote.TaxAmount2,  OrderCombineQuote.TaxAmount3,  OrderCombineQuote.TaxAmount4,  OrderCombineQuote.TaxAmount5,  OrderCombineQuote.TaxAmount6,  SalesRep.Description AS SalesRepName,  OrderProcess.BWT,  OrderProcess.Description AS ProcessDescription,  OrderProcess.Color,  OrderProcess.ItemNumber,  OrderProcess.GroupNo,  OrderProcess.Caliper,  OrderProcess.ColorsSide1,  OrderProcess.ColorsSide2,  Terms.Description AS TermsDescription,  OrderComponentText.DetailDescription AS MCompDetailDescription,  OrderComponentText.PPInstructions AS MPPInstructions,  OrderComponentText.PostInstructions AS MPostInstructions,  Terms.Code AS TermsCode,  OrderComponentText.StockInstructions AS MStockInstructions,  OrderComponentText.ASInstructions AS MASInstructions,  Company.CompanyName,  Company.CompanyAddress1,  Company.CompanyAddress2,  Company.CompanyAddress3,  Company.CompanyCity,  Company.CompanyState,  Company.CompanyZip,  Company.CompanyPhone,  Company.CompanyFax,  Company.CompanyCountry,  Company.QuoteMessage,  OrderHeader.MNotes,  Contact.Phone AS ContactPhone,  Contact.Fax AS ContactFax,  OrderHeader.PlantID,  Company.MQuoteMessage,  Company.CompanyName AS PlantName,  Company.CompanyAddress1 AS PlantAddress1,  Company.CompanyAddress2 AS PlantAddress2,  Company.CompanyAddress3 AS PlantAddress3,  Company.CompanyCity AS PlantCity,  Company.CompanyState AS PlantState,  Company.CompanyZip AS PlantZip,  Company.CompanyPhone AS PlantPhone,  Company.CompanyFax AS PlantFax,  Company.CompanyCountry AS PlantCountry,  Company.MQuoteMessage AS PlantMQuoteMessage,  (Select OptionValue from AccessControl Where Source = 'SystemSetting' and LoginName = 'PSD' and OptionName = 'CountryVersion') as CountryVersion,  OrderHeader.CustAddress3,  TempQuoteReport.AddChargeDescription1,  TempQuoteReport.AddChargeDescription2,  TempQuoteReport.AddChargeDescription3,  TempQuoteReport.AddChargeCost1,  TempQuoteReport.AddChargeCost2,  TempQuoteReport.AddChargeCost3,  TempQuoteReport.Prepress1,  TempQuoteReport.Prepress2,  TempQuoteReport.Prepress3,  TempQuoteReport.Prepress4,  TempQuoteReport.Prepress5,  TempQuoteReport.Prepress6,  TempQuoteReport.Prepress7,  TempQuoteReport.Prepress8,  TempQuoteReport.Prepress9,  TempQuoteReport.Prepress10,  TempQuoteReport.Postpress1,  TempQuoteReport.Postpress2,  TempQuoteReport.Postpress3,  TempQuoteReport.Postpress4,  TempQuoteReport.Postpress5,  TempQuoteReport.Postpress6,  TempQuoteReport.Postpress7,  TempQuoteReport.Postpress8,  TempQuoteReport.Postpress9,  TempQuoteReport.Postpress10,  OrderComponent.FinalWidth,  OrderComponent.FinalLength,  OrderCombineQuote.CQuantity1,  OrderCombineQuote.CQuantity2,  OrderCombineQuote.CQuantity3,  OrderCombineQuote.CQuantity4,  OrderCombineQuote.CQuantity5,  OrderCombineQuote.CQuantity6,  Contact.CellPhone AS ContactCellPhone,  Contact.Email AS ContactEmail,  Contact.JobTitle,  SalesRep.Title AS SalesRepTitle,  OrderComponent.UserDefined1 AS CUserDefined1,  OrderComponent.UserDefined2 AS CUserDefined2,  OrderComponent.UserDefined3 AS CUserDefined3,  OrderComponent.UserDefined4 AS CUserDefined4,  OrderComponent.UserDefined5 AS CUserDefined5,  OrderComponent.Color1SidedSheets,  OrderComponent.Color2SidedSheets,  OrderComponent.BlankSheets,  OrderComponentText.InkInstructions AS MInkInstructions,  OrderComponentText.PressInstructions AS MPressInstructions,  OrderComponent.ComboSheets,  OrderHeader.UserDefined1 AS HUserDefined1,  OrderHeader.UserDefined2 AS HUserDefined2,  OrderHeader.UserDefined3 AS HUserDefined3,  OrderHeader.UserDefined4 AS HUserDefined4,  OrderHeader.UserDefined5 AS HUserDefined5,  OrderQtyTable.QuantityLineNo,  OrderHeader.TotalComponents,  Company.ReportImage,  OrderComponent.GroupName,  SalesRep.Phone AS SalesRepPhone,  SalesRep.Email AS SalesRepEmail,  Employee.Phone AS EstPhone, Employee.MobilePhone AS EstMobile, Employee.Email AS EstEmail, OrderComponent.FlexoDieCharge  FROM   OrderQtyTable  INNER JOIN OrderComponent  ON OrderQtyTable.JobNumber = OrderComponent.JobNumber  AND OrderQtyTable.ComponentNumber = OrderComponent.ComponentNumber  INNER JOIN OrderComponentText  ON OrderComponent.JobNumber = OrderComponentText.JobNumber  AND OrderComponent.ComponentNumber = OrderComponentText.ComponentNumber  INNER JOIN OrderHeader  ON OrderComponent.JobNumber = OrderHeader.JobNumber  INNER JOIN OrderCombineQuote  ON OrderHeader.JobNumber = OrderCombineQuote.JobNumber  LEFT JOIN SalesRep  ON OrderHeader.SalesRepCode = SalesRep.Code  LEFT OUTER JOIN Employee ON OrderHeader.Estimator = Employee.Code  LEFT JOIN OrderProcess  ON OrderComponent.JobNumber = OrderProcess.JobNumber  AND OrderComponent.ComponentNumber = OrderProcess.ComponentNumber  AND (OrderProcess.GroupNo = 3 AND OrderProcess.ItemNumber = 1)  LEFT JOIN Customer  ON OrderHeader.CustAccount = Customer.Account  LEFT JOIN Terms  ON Customer.TermsCode = Terms.Code  LEFT JOIN Contact  ON Customer.Account = Contact.Account  AND OrderHeader.CustContactID = Contact.ID  LEFT JOIN TempQuoteReport  ON OrderComponent.JobNumber = TempQuoteReport.KeyNumber  AND OrderComponent.ComponentNumber = TempQuoteReport.ComponentNumber  AND TempQuoteReport.JobType = 'ORDER'  LEFT JOIN Company  ON Company.CompanyID = (CASE WHEN OrderHeader.PlantID <> '' THEN OrderHeader.PlantID ELSE 'PSD' END)  WHERE   OrderHeader.JobNumber = @KeyNumber